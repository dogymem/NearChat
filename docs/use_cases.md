# NearChat – Use Case Analysis

## Actors

### **User (Пользователь)**
Базовая роль любого человека, открывшего приложение. Может настраивать профиль и выбирать режим работы приложения.

### **Host (Сервер)**
Пользователь, выбравший режим "Сервер". Инициирует сессию чата, открывает порт для входящих соединений и управляет трансляцией сообщений между участниками.

### **Client (Клиент)**
Пользователь, выбравший режим "Клиент". Подключается к активному серверу по локальной сети, используя IP-адрес и порт.

### **System (NearChat App)**
Само приложение, выполняющее фоновые задачи: управление TCP-соединениями, кодирование/декодирование сообщений и обновление пользовательского интерфейса.

---

## Use Case Scenarios

### **UC1: Configure User Profile**

**Actor:** User  
**Precondition:** Приложение запущено, открыта вкладка "Настройки".

**Flow of Events:**
1. Пользователь вводит желаемое имя в текстовое поле "Ваш никнейм".
2. Пользователь нажимает кнопку "Сохранить никнейм".
3. Система сохраняет введенное значение в постоянное хранилище (`@AppStorage`).
4. Система скрывает экранную клавиатуру.

**Alternative Flows:**
- **Поле ввода пустое или состоит из пробелов** → Кнопка "Сохранить никнейм" остается неактивной (disabled), действие невозможно.

**Postcondition:** У пользователя установлен никнейм, который будет использоваться для идентификации в чате.

---

### **UC2: Start Chat Server (Host)**

**Actor:** Host  
**Precondition:** Никнейм установлен, пользователь находится на вкладке "Настройки".

**Flow of Events:**
1. Пользователь в блоке "Режим работы" выбирает опцию "Сервер".
2. Система автоматически определяет IP-адрес устройства в сети Wi-Fi и отображает его пользователю.
3. Пользователь подтверждает или изменяет порт (по умолчанию 12345).
4. Система запускает `NWListener` и начинает прослушивание порта.
5. Статус соединения меняется на `.listening` ("Сервер слушает").
6. Пользователь переходит на вкладку "Чат", где снимается блокировка экрана (Overlay).

**Alternative Flows:**
- **Порт занят или ошибка сети** → Система переводит статус в `.failed` ("Ошибка создания сервера"), в консоль выводится описание ошибки, сервер останавливается.

**Postcondition:** Устройство готово принимать входящие подключения от клиентов.

---

### **UC3: Connect to Chat (Client)**

**Actor:** Client  
**Precondition:** Сервер (Host) запущен на другом устройстве, Клиент знает IP-адрес Сервера.

**Flow of Events:**
1. Пользователь в блоке "Режим работы" выбирает опцию "Клиент".
2. Пользователь вводит IP-адрес сервера и порт в соответствующие поля.
3. Пользователь нажимает кнопку "Подключиться".
4. Система меняет статус на `.connecting` и инициирует TCP-соединение (`NWConnection`).
5. При успешном рукопожатии (handshake) статус меняется на `.connected`.
6. Система начинает прослушивание входящих сообщений от сервера.
7. Пользователь переходит на вкладку "Чат", блокировка экрана снимается.

**Alternative Flows:**
- **Сервер недоступен или неверный IP** → Система не получает ответ, статус меняется на `.failed`, выводится сообщение об ошибке.
- **Разрыв соединения** → Если сервер отключается, клиент получает уведомление, статус меняется на `.disconnected`, экран чата блокируется.

**Postcondition:** Установлен двусторонний канал связи с сервером.

---

### **UC4: Send Message**

**Actor:** Host / Client  
**Precondition:** Соединение активно (статус `.listening` или `.connected`), пользователь находится на вкладке "Чат".

**Flow of Events:**
1. Пользователь вводит текст сообщения в поле ввода.
2. Пользователь нажимает кнопку "Отправить".
3. Система формирует пакет данных в формате `Timestamp:Base64(Nickname):Base64(Message)`.
4. Сообщение немедленно добавляется в локальную историю чата.
5. Система передает данные по сети:
   - **Client** отправляет данные на Сервер.
   - **Host** отправляет данные всем подключенным Клиентам (Broadcast).
6. Поле ввода очищается.

**Alternative Flows:**
- **Текст сообщения пуст** → Кнопка "Отправить" неактивна.

**Postcondition:** Сообщение отправлено получателям и отображается в истории.

---

### **UC5: Relay Messages (Server Logic)**

**Actor:** System (Host)  
**Precondition:** Сервер запущен, подключено 2 и более клиентов.

**Flow of Events:**
1. Сервер получает пакет данных от одного из подключенных Клиентов.
2. Система декодирует сообщение и добавляет его в историю чата на устройстве Хоста.
3. Система вызывает функцию `broadcast`, пересылая полученный пакет всем остальным активным соединениям (кроме отправителя).

**Postcondition:** Все участники чата видят сообщение, отправленное одним из клиентов.

---

### **UC6: Terminate Session**

**Actor:** User (Host / Client)  
**Precondition:** Приложение находится в активном режиме (Сервер или Клиент).

**Flow of Events:**
1. Пользователь меняет режим в настройках (например, на "Не выбрано") или сворачивает приложение.
2. Система вызывает метод `stop()`.
3. Все активные `NWConnection` и `NWListener` отменяются.
4. Статус переходит в состояние `.stopped`.
5. На экране чата появляется блокирующий оверлей ("Остановлено" или "Проверьте настройки").

**Postcondition:** Сетевая активность полностью прекращена, ресурсы освобождены.